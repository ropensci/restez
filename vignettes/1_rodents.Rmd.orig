---
title: "1. Build a database of all rodents"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(restez)

# hide my wd
original_status_class <- getFromNamespace(x = 'status_class', ns = 'restez')
status_class2 <- function() {
  res <- original_status_class()
  res$`Restez path`$`Path` <- '[RODENTS PATH]/restez'
  res$`Download`$`Path` <- '[RODENTS PATH]/restez/downloads'
  res$`Database`$`Path` <- '[RODENTS PATH]/restez/sql_db'
  res
}
assignInNamespace(x = 'status_class', value = status_class2, ns = 'restez')

# Get download and build times
# rodent_build_times.RDS generated by rodent_db.R
rodent_build_times <- readRDS(here::here("other/rodent_build_times.RDS"))
dl_time_hr <- round(rodent_build_times$dl_time[["elapsed"]] / 60 / 60, 1)
db_time_hr <- round(rodent_build_times$db_time[["elapsed"]] / 60 / 60, 1)
```

In this first tutorial we are going to build a database for all rodents. The rodents are a good test case for playing with `restez` as they are a relatively small domain in GenBank but still have charismatic organisms that people are familiar enough with to understand. We will also limit the number of sequences in the database by limiting the sequence sizes between 100 and 1000.

The database you build here will be used again in later tutorials and you may wish to experiment with it yourself. Therefore it is best to locate a suitable place in your harddrive where you would like to store it for later reference. In this tutorial and in others, we will always refer to the rodents' `restez` path with the variable `rodents_path`.

Setting up the rodents database will likely take a long time. The exact time will depend on your internet speeds and machine specs. For reference, this vigenette was written on an iMac (2019) with a download speed of 56 MBPS. With this setup, downloading the database took `r dl_time_hr` hr and creating the database took `r db_time_hr` hr.

Note GenBank domains (i.e., major parts of GenBank split by major taxonomic group) are specified by number. As of writing, rodents are number 7, but the numbering scheme may change between releases, so don't assume this will necessarily be the case in future releases. You can check the current number scheme by running `db_download()` without any input to `preselection`.

## Download
```{r setpath, include=FALSE, eval=TRUE}
# reminder to self: other/rodent_db.R
pkgwd <- sub(pattern = 'vignettes', replacement = '', x = getwd())
rodents_path <- paste0(pkgwd, '/rodents')
if (!dir.exists(rodents_path)) {
  stop('other/rodent_db.R must be run first!', call. = FALSE)
}
restez_path_set(rodents_path)
```

```{r download, eval=FALSE, include=TRUE}
library(restez)
# set the restez path to a memorable location
restez_path_set(rodents_path)
# download for domain 7 (rodents as of GenBank release 256)
db_download(preselection = '7')
```

## Build
```{r build, eval=FALSE, include=TRUE}
db_create(min_length = 100, max_length = 1000)
```

## Check status
```{r status, echo=TRUE}
restez_status()
```

## Next up

**[How to search for and fetch sequences](https://docs.ropensci.org/restez/articles/2_search_and_fetch.html)**
